function formatData(e){if(!e.id)return e.text;var t=$('<div style="display:inline-block;float:right"><span style="text-align:right;font-style:italic; font-size:small; color:grey">'+e.dci+'</span></div><div style:"display:inline-block"><span>'+e.text+" </span></div>");return t}function message(e,t){var a=$('<div class="alert alert-'+e+' error-message alert-fixed" style="display: none;">');a.append(t),a.appendTo($("#message")).fadeIn(300).delay(3e3).fadeOut(500)}function divHover(){$("#planprise tr, .action").hover(function(){$(this).find(".action").removeClass("hover")},function(){$(this).find(".action").addClass("hover")}),$(".supprime").click(function(e){e.preventDefault();var t=$(this);t.addClass("disabled");var a=t.data("id");$.ajax({url:"/ajax/pp.ajax.php?supprime",type:"get",data:"id_medic="+a,dataType:"text",cache:!1,success:function(){$(".row_"+a).fadeOut(),$(".print-precaution").load("plandeprise.php .print-precaution"),$("#badgePP").html(function(e,t){return 1*t-1}).addClass("badge"),t.removeClass("disabled")},error:function(){var e="Le médicament n'a pas pu être retiré du plan de prise. Merci de réessayer.";message("warning",e),t.removeClass("disabled")}})}),$(".resize").click(function(e){e.preventDefault();var t=$(this),a=$(this).closest("tr"),n=t.data("id");t.addClass("disabled"),$.ajax({url:"/ajax/pp.ajax.php?resize",type:"get",data:"id_medic="+n,dataType:"text",success:function(){a.find(".fusion").toggleClass("hidden"),a.find("td.success").toggleClass("hidden"),a.find("td.warning").toggleClass("hidden"),a.find("td.danger").toggleClass("hidden"),t.removeClass("disabled")},error:function(){t.removeClass("disabled")}})})}function loadEditable(){$.fn.editable.defaults.onblur="submit",$(".editable-inline").editable({mode:"inline",emptytext:"&nbsp; &nbsp; &nbsp; &nbsp; </br> &nbsp;",showbuttons:!1}),$(".editable-popup").editable({placement:"bottom",emptytext:"&nbsp; &nbsp; &nbsp; &nbsp; </br> &nbsp;"}),$(".editable-poso").editable({mode:"inline",showbuttons:!1,tpl:'<input type="text" style="width:4em;text-align:center">',emptytext:"&nbsp; &nbsp; &nbsp; &nbsp; </br> &nbsp;"}),$(".editable-com").editable({mode:"inline",showbuttons:!1,emptytext:"Ajouter un commentaire",emptyclass:"com-empty"}),$(".option").editable({mode:"inline",showbuttons:!1,emptytext:"Ajouter un commentaire",emptyclass:"com-empty",tpl:"<input type='text' class='option-item'>"}),$(".choix").change(function(){var e=$(this),t=e.data("texte"),a=e.data("id"),n=e.data("action"),i=e.parents("td");$.ajax({url:"/ajax/pp.ajax.php?"+n,type:"get",data:"id_medic="+a+"&texte="+t,dataType:"text",success:function(){if("indication"===n){var e='<a href="#" class="indication-simple editable-inline" data-type="textarea" data-name="indication" data-pk="'+a+'" data-url="editable_grid.php">'+t+"</a>";i.html(e),loadEditable(),""===t&&i.find(".editable-inline").editable("toggle")}else i.text(t)},error:function(){}})})}function selectAjout(){$("#choix-medic").select2({language:"fr",placeholder:"Ajouter un médicament au plan de prise...",ajax:{url:"/ajax/choixMedic.php",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){return{results:e}},cache:!0},minimumInputLength:3,theme:"bootstrap",templateResult:formatData}).select2("open")}function submitOnChange(){$("#choix-medic").on("select2:select",function(){var e=$(this),t=e.val(),a='<tr class="progress hidden" id="spinner" style="margin-top:7px;"><td>';a+='<div class="progress-bar progress-bar-info progress-bar-striped active" role="progressbar" style="width:100%"></div>',a+="</td></tr>",$("table").html(a),null!==t&&$.ajax({url:"/ajax/pp.ajax.php?ajout",type:"get",data:e.serialize(),dataType:"json",cache:!1,success:function(e){if("success"===e.error)$("#loadPP").load("pp_include.php"),$(".print-precaution").load("plandeprise.php .print-precaution"),$("#badgePP").html(function(e,t){return 1*t+1}).addClass("badge"),$("#PPrise").removeClass("hidden");else if("present"===e.error){var t="<strong>"+e.nom+"</strong> est déjà présent dans le plan de prise";message("warning",t),$("table").html(tableContent)}},error:function(){var e="Le médicament n'a pas pu être ajouté au plan de prise. Merci de réessayer.";message("danger",e),$("table").html(tableContent)}}),$(".ajout-vide").remove(),$("#boutonMedic").removeClass("hidden"),$(".alert-info").addClass("hidden"),$(document).ajaxComplete(function(){loadEditable(),divHover()})})}function loadAjout(){if(tableContent=$("table").html(),0===$("tbody").children().length){var e='<form class="form-ajout ajout-vide" method="get" action="pp.ajax.php?ajout">';e+='<select id="choix-medic" class="form-control" name="id_medic">',e+="</select>",e+="</form>",$("#ajout-row").append(e),selectAjout(),submitOnChange()}}function options(){$("#options").toggle(),$("#boutonOptions").toggle()}$(document).ready(function(){divHover(),loadEditable(),loadAjout(),$(".button-checkbox").each(function(){function e(){var e=n.is(":checked");a.data("state",e?"on":"off"),a.find(".state-icon").removeClass().addClass("state-icon "+s[a.data("state")].icon),e?a.removeClass("btn-link").addClass("btn-"+i+" active").html("&nbsp;Cacher une colonne coucher"):a.removeClass("btn-"+i+" active").addClass("btn-link").html("&nbsp;Afficher une colonne coucher"),0===a.find(".state-icon").length&&a.prepend('<i class="state-icon '+s[a.data("state")].icon+'"></i>')}var t=$(this),a=t.find("button"),n=t.find("input:checkbox"),i=a.data("color"),s={on:{icon:"glyphicon glyphicon-check"},off:{icon:"glyphicon glyphicon-unchecked"}};a.on("click",function(){n.prop("checked",!n.is(":checked")),n.triggerHandler("change"),e()}),n.on("change",function(){$.ajax({url:"/ajax/pp.ajax.php?coucher",type:"get",data:"",dataType:"html",success:function(){$(".posologie .info").toggleClass("hidden"),options(),e()}})}),e()})}),$("#ajouter-ligne").click(function(){if(0===$(".vide").length){$("table tr:last").clone().removeClass().addClass("vide").insertAfter("table tr:last").show(),$("table tr:last td").empty();var e='<form class="form-ajout" method="get" action="pp.ajax.php?ajout">';e+='<select id="choix-medic" class="form-control" name="id_medic">',e+="</select>",e+="</form>";var t=$("table tr:last").children("td").not(".hidden").length;t=--t,$("table tr:last td:first").html(e).attr("colspan",t),$("table tr:last td:not(:first)").addClass("hidden"),selectAjout(),submitOnChange()}}),$(".check-commentaire").change(function(){var e=$(this),t=e.data("id"),a=e.data("rang"),n="";e.prop("checked")&&(n="checked"),$.ajax({url:"/ajax/pp.ajax.php?commentaire",type:"get",data:"id_medic="+t+"&rang="+a+"&status="+n,dataType:"text",success:function(){"checked"===n?e.parent().find(".option").removeClass("gris"):e.parent().find(".option").addClass("gris")},error:function(){}})}),$("#bouton-options, #hide-options").click(function(){options()});